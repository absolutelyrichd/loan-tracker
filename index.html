<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Pelacakan Utang (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        #loading-overlay, #login-screen {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.3s;
        }
        #loading-overlay { background-color: rgba(243, 244, 246, 0.9); }
        #login-screen { background-color: #f3f4f6; }
        .hidden { display: none; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-3 text-gray-600">Memuat data...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden">
        <div class="text-center bg-white p-10 rounded-xl shadow-lg">
            <h1 class="text-2xl font-bold text-gray-800">Selamat Datang</h1>
            <p class="text-gray-600 mt-2 mb-6">Silakan masuk untuk mengelola keuangan Anda.</p>
            <button id="login-btn" class="bg-white text-gray-700 font-semibold px-6 py-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition shadow-sm flex items-center mx-auto">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.901,35.636,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                </svg>
                Masuk dengan Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Dasbor Keuangan Pribadi</h1>
                <p class="text-gray-600 mt-1">Lacak, kelola, dan analisis utang Anda dengan mudah.</p>
            </div>
            <div id="user-info" class="flex items-center space-x-4">
                <span id="user-name" class="font-semibold text-gray-700 hidden md:block"></span>
                <img id="user-photo" class="w-10 h-10 rounded-full" alt="User photo">
                <button id="logout-btn" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition">Keluar</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <label for="monthly-salary" class="block text-sm font-medium text-gray-700 mb-2">Penghasilan per Bulan (Rp)</label>
                    <input type="number" id="monthly-salary" placeholder="Contoh: 5000000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-md font-medium text-gray-500">Total Sisa Utang</h3>
                        <p id="total-remaining-debt" class="text-3xl font-bold text-red-600 mt-2">Rp 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-md font-medium text-gray-500">Total Cicilan / Bulan</h3>
                        <p id="total-monthly-payment" class="text-3xl font-bold text-orange-500 mt-2">Rp 0</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Analisis Kemampuan Bayar</h3>
                    <div class="space-y-4">
                        <div id="current-month-analysis" class="p-4 rounded-lg border-l-4"><h4 class="font-semibold">Bulan Ini</h4><p id="current-month-status" class="text-sm"></p><p id="current-month-remaining" class="text-sm font-medium"></p></div>
                        <div id="long-term-analysis" class="p-4 rounded-lg border-l-4"><h4 class="font-semibold">Proyeksi Jangka Panjang</h4><p id="long-term-status" class="text-sm"></p><p id="long-term-info" class="text-sm"></p></div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">Detail Utang Anda</h2>
                        <button id="add-debt-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow">+ Tambah Utang</button>
                    </div>
                    <div id="debt-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <div id="empty-state" class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Belum ada utang</h3>
                            <p class="mt-1 text-sm text-gray-500">Mulai dengan menambahkan utang pertama Anda.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="debt-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="modal-content" class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4 modal-enter">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-900">Tambah Utang Baru</h2>
            <form id="debt-form"><input type="hidden" id="debt-id"><div class="space-y-4"><div><label for="debt-name" class="block text-sm font-medium text-gray-700">Nama Pinjaman</label><input type="text" id="debt-name" placeholder="Contoh: KTA Bank Mandiri" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div><div><label for="debt-installment" class="block text-sm font-medium text-gray-700">Cicilan per Bulan (Rp)</label><input type="number" id="debt-installment" placeholder="Contoh: 1000000" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div><div><label for="debt-tenure" class="block text-sm font-medium text-gray-700">Total Tenor (Bulan)</label><input type="number" id="debt-tenure" placeholder="Contoh: 24" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div><div><label for="debt-paid" class="block text-sm font-medium text-gray-700">Cicilan yang Sudah Dibayar (Bulan)</label><input type="number" id="debt-paid" placeholder="Contoh: 5" value="0" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required></div></div><div class="mt-8 flex justify-end space-x-3"><button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition">Batal</button><button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700 transition shadow">Simpan</button></div></form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, signOut, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCye5vR5CfjVww2BJO90EfVIH0mVsq3Jt8",
            authDomain: "loan-tracker-c58b3.firebaseapp.com",
            projectId: "loan-tracker-c58b3",
            storageBucket: "loan-tracker-c58b3.firebasestorage.app",
            messagingSenderId: "674547925668",
            appId: "1:674547925668:web:17e8896c3c7d6c35ea1c31",
            measurementId: "G-0ZYPY4985T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const loadingOverlay = document.getElementById('loading-overlay');
        const loginScreen = document.getElementById('login-screen');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const appContainer = document.getElementById('app');
        const userInfo = document.getElementById('user-info');
        const userNameEl = document.getElementById('user-name');
        const userPhotoEl = document.getElementById('user-photo');
        
        const salaryInput = document.getElementById('monthly-salary');
        const totalRemainingDebtEl = document.getElementById('total-remaining-debt');
        const totalMonthlyPaymentEl = document.getElementById('total-monthly-payment');
        const debtListEl = document.getElementById('debt-list');
        const emptyStateEl = document.getElementById('empty-state');
        const currentMonthAnalysisEl = document.getElementById('current-month-analysis');
        const currentMonthStatusEl = document.getElementById('current-month-status');
        const currentMonthRemainingEl = document.getElementById('current-month-remaining');
        const longTermAnalysisEl = document.getElementById('long-term-analysis');
        const longTermStatusEl = document.getElementById('long-term-status');
        const longTermInfoEl = document.getElementById('long-term-info');
        const debtModal = document.getElementById('debt-modal');
        const modalContent = document.getElementById('modal-content');
        const addDebtBtn = document.getElementById('add-debt-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const debtForm = document.getElementById('debt-form');
        const modalTitle = document.getElementById('modal-title');
        const debtIdInput = document.getElementById('debt-id');

        let debts = [];
        let monthlySalary = 0;
        let dbRef = null;
        let unsubscribe;

        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);

        const saveDataToFirestore = async () => {
            if (!dbRef) return;
            try {
                await setDoc(dbRef, { debts, monthlySalary });
            } catch (e) {
                console.error("Error writing document: ", e);
                alert('Gagal menyimpan data ke server.');
            }
        };

        const renderDashboard = () => {
            const totalMonthlyPayment = debts.reduce((sum, debt) => sum + debt.installment, 0);
            const totalRemainingDebt = debts.reduce((sum, debt) => sum + (debt.tenure - debt.paid) * debt.installment, 0);
            const maxTenure = Math.max(0, ...debts.map(d => d.tenure - d.paid));

            totalRemainingDebtEl.textContent = formatCurrency(totalRemainingDebt);
            totalMonthlyPaymentEl.textContent = formatCurrency(totalMonthlyPayment);

            renderDebtList();
            updateAffordabilityAnalysis(totalMonthlyPayment, maxTenure);
        };

        const renderDebtList = () => {
            debtListEl.innerHTML = '';
            if (debts.length === 0) {
                debtListEl.appendChild(emptyStateEl);
                emptyStateEl.style.display = 'block';
            } else {
                emptyStateEl.style.display = 'none';
                debts.forEach(debt => {
                    const remainingMonths = debt.tenure - debt.paid;
                    const remainingDebt = remainingMonths * debt.installment;
                    const card = document.createElement('div');
                    card.className = 'border border-gray-200 p-5 rounded-lg bg-white hover:shadow-lg transition-shadow duration-300';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-lg font-bold text-gray-800">${debt.name}</h4>
                                <p class="text-sm text-gray-500">Cicilan: ${formatCurrency(debt.installment)} / bulan</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-id="${debt.id}" class="edit-btn text-gray-400 hover:text-blue-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                                <button data-id="${debt.id}" class="delete-btn text-gray-400 hover:text-red-600 p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${(debt.paid / debt.tenure) * 100}%"></div></div>
                            <div class="flex justify-between text-sm text-gray-600 mt-2"><span>Telah dibayar: ${debt.paid} dari ${debt.tenure} bulan</span><span class="font-semibold">Sisa: ${remainingMonths} bulan</span></div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 text-right"><span class="text-gray-600">Sisa Pokok Utang: </span><span class="font-bold text-lg text-gray-800">${formatCurrency(remainingDebt)}</span></div>
                    `;
                    debtListEl.appendChild(card);
                });
            }
        };

        const updateAffordabilityAnalysis = (totalMonthlyPayment, maxTenure) => {
            if (monthlySalary > 0) {
                const remainingSalary = monthlySalary - totalMonthlyPayment;
                if (remainingSalary >= 0) {
                    currentMonthAnalysisEl.className = 'p-4 rounded-lg border-l-4 border-green-500 bg-green-50';
                    currentMonthStatusEl.textContent = 'Gaji CUKUP untuk membayar cicilan bulan ini.';
                    currentMonthStatusEl.className = 'font-semibold text-green-800';
                    currentMonthRemainingEl.textContent = `Sisa uang setelah bayar cicilan: ${formatCurrency(remainingSalary)}`;
                } else {
                    currentMonthAnalysisEl.className = 'p-4 rounded-lg border-l-4 border-red-500 bg-red-50';
                    currentMonthStatusEl.textContent = 'Gaji TIDAK CUKUP untuk membayar cicilan bulan ini.';
                    currentMonthStatusEl.className = 'font-semibold text-red-800';
                    currentMonthRemainingEl.textContent = `Kekurangan dana: ${formatCurrency(Math.abs(remainingSalary))}`;
                }
                if (maxTenure > 0) {
                     if (remainingSalary >= 0) { longTermAnalysisEl.className = 'p-4 rounded-lg border-l-4 border-green-500 bg-green-50'; longTermStatusEl.textContent = 'AMAN. Gaji Anda diproyeksikan cukup.'; longTermStatusEl.className = 'font-semibold text-green-800'; longTermInfoEl.textContent = `Dengan asumsi gaji tetap, Anda bisa menutupi cicilan selama ${maxTenure} bulan ke depan.`; } else { longTermAnalysisEl.className = 'p-4 rounded-lg border-l-4 border-red-500 bg-red-50'; longTermStatusEl.textContent = 'BERISIKO. Gaji Anda diproyeksikan tidak cukup.'; longTermStatusEl.className = 'font-semibold text-red-800'; longTermInfoEl.textContent = `Anda perlu mencari sumber pendapatan lain atau negosiasi utang.`; }
                } else { longTermAnalysisEl.className = 'p-4 rounded-lg border-l-4 border-gray-500 bg-gray-50'; longTermStatusEl.textContent = 'Tidak ada utang jangka panjang.'; longTermStatusEl.className = 'font-semibold text-gray-800'; longTermInfoEl.textContent = 'Semua utang Anda sudah lunas atau tidak ada sama sekali.'; }
            } else {
                currentMonthAnalysisEl.className = 'p-4 rounded-lg border-l-4 border-gray-500 bg-gray-50';
                currentMonthStatusEl.textContent = 'Masukkan jumlah gaji Anda untuk melihat analisis.';
                currentMonthStatusEl.className = 'font-semibold text-gray-800';
                currentMonthRemainingEl.textContent = '';
                longTermAnalysisEl.className = 'p-4 rounded-lg border-l-4 border-gray-500 bg-gray-50';
                longTermStatusEl.textContent = 'Analisis jangka panjang memerlukan data gaji.';
                longTermStatusEl.className = 'font-semibold text-gray-800';
                longTermInfoEl.textContent = '';
            }
        };

        const openModal = (debt = null) => {
            debtForm.reset();
            if (debt) {
                modalTitle.textContent = 'Edit Utang';
                debtIdInput.value = debt.id;
                document.getElementById('debt-name').value = debt.name;
                document.getElementById('debt-installment').value = debt.installment;
                document.getElementById('debt-tenure').value = debt.tenure;
                document.getElementById('debt-paid').value = debt.paid;
            } else {
                modalTitle.textContent = 'Tambah Utang Baru';
                debtIdInput.value = '';
            }
            debtModal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.add('modal-enter-active'), 10);
        };

        const closeModal = () => {
            modalContent.classList.remove('modal-enter-active');
            modalContent.classList.add('modal-leave-active');
            setTimeout(() => { debtModal.classList.add('hidden'); modalContent.classList.remove('modal-leave-active'); }, 200);
        };
        
        // --- Event Listeners ---
        loginBtn.addEventListener('click', () => {
            signInWithRedirect(auth, provider).catch(error => console.error("Login with Google failed:", error));
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        
        salaryInput.addEventListener('input', (e) => {
            monthlySalary = parseFloat(e.target.value) || 0;
            saveDataToFirestore(); 
        });

        addDebtBtn.addEventListener('click', () => openModal());
        cancelBtn.addEventListener('click', closeModal);
        debtModal.addEventListener('click', (e) => { if (e.target === debtModal) closeModal(); });

        debtForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = debtIdInput.value;
            const newDebt = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('debt-name').value, installment: parseFloat(document.getElementById('debt-installment').value), tenure: parseInt(document.getElementById('debt-tenure').value), paid: parseInt(document.getElementById('debt-paid').value) };
            if (newDebt.paid > newDebt.tenure) { alert('Cicilan yang sudah dibayar tidak boleh lebih besar dari total tenor.'); return; }
            if (id) { debts[debts.findIndex(d => d.id === newDebt.id)] = newDebt; } else { debts.push(newDebt); }
            closeModal();
            saveDataToFirestore();
        });

        debtListEl.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const id = parseInt(button.dataset.id);
            if (button.classList.contains('delete-btn')) {
                if (confirm('Apakah Anda yakin ingin menghapus utang ini?')) {
                    debts = debts.filter(d => d.id !== id);
                    saveDataToFirestore();
                }
            }
            if (button.classList.contains('edit-btn')) {
                openModal(debts.find(d => d.id === id));
            }
        });

        // --- Auth State Change Handler ---
        // Menampilkan overlay saat halaman dimuat untuk menangani status redirect
        loadingOverlay.classList.remove('hidden');
        appContainer.classList.add('hidden');
        loginScreen.classList.add('hidden');

        // Memeriksa hasil redirect saat aplikasi dimuat
        getRedirectResult(auth)
          .catch((error) => {
            console.error("Error processing redirect result:", error);
            alert("Terjadi kesalahan saat memproses login.");
          });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                userNameEl.textContent = user.displayName;
                userPhotoEl.src = user.photoURL;
                userInfo.classList.remove('hidden');

                dbRef = doc(db, "users", user.uid);
                if (unsubscribe) unsubscribe();

                unsubscribe = onSnapshot(dbRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        debts = data.debts || [];
                        monthlySalary = data.monthlySalary || 0;
                    } else {
                        debts = [];
                        monthlySalary = 0;
                        saveDataToFirestore(); 
                    }
                    salaryInput.value = monthlySalary > 0 ? monthlySalary : '';
                    renderDashboard();
                    loadingOverlay.classList.add('hidden');
                }, (error) => {
                    console.error("Error listening to document:", error);
                    alert("Gagal mengambil data dari server.");
                    loadingOverlay.classList.add('hidden');
                });
            } else {
                // User is signed out
                if (unsubscribe) unsubscribe();
                dbRef = null;
                debts = [];
                monthlySalary = 0;
                renderDashboard(); // Clear the dashboard
                
                loadingOverlay.classList.add('hidden');
                appContainer.classList.add('hidden');
                userInfo.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
