import React, { useState, useEffect } from 'react';
import { CreditCard, Wallet, CheckCircle, XCircle, Plus, Edit, Trash2, Calendar, PiggyBank, Search } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// Komponen Card untuk menampilkan ringkasan data
const StatCard = ({ icon: Icon, title, value, colorClass }) => (
  <motion.div
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    transition={{ duration: 0.3 }}
    className={`flex flex-col items-center p-6 rounded-3xl shadow-xl transform transition-all duration-300 hover:scale-105 ${colorClass} text-white`}
  >
    <Icon size={48} />
    <h3 className="mt-4 text-xl font-bold">{title}</h3>
    <p className="mt-2 text-3xl font-extrabold">{value}</p>
  </motion.div>
);

// Komponen formulir untuk menambah/mengedit utang
const DebtFormModal = ({ isOpen, onClose, onSubmit, initialData = {} }) => {
  // Fix: Use optional chaining to safely access properties from initialData
  const [debtName, setDebtName] = useState(initialData?.name || '');
  const [originalAmount, setOriginalAmount] = useState(initialData?.originalAmount || '');
  const [monthlyPayment, setMonthlyPayment] = useState(initialData?.monthlyPayment || '');
  const [remainingMonths, setRemainingMonths] = useState(initialData?.remainingMonths || '');
  const [dueDate, setDueDate] = useState(initialData?.dueDate || '');

  const handleSubmit = (e) => {
    e.preventDefault();
    const data = {
      ...initialData,
      name: debtName,
      originalAmount: parseFloat(originalAmount),
      monthlyPayment: parseFloat(monthlyPayment),
      remainingMonths: parseInt(remainingMonths),
      remainingAmount: (parseInt(remainingMonths) || 0) * (parseFloat(monthlyPayment) || 0),
      dueDate: parseInt(dueDate),
      lastPaymentDate: initialData?.lastPaymentDate || null, // Safely access lastPaymentDate
    };
    onSubmit(data);
    onClose();
  };

  return (
    <AnimatePresence>
      {isOpen && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
        >
          <motion.div
            initial={{ scale: 0.9, opacity: 0 }}
            animate={{ scale: 1, opacity: 1 }}
            exit={{ scale: 0.9, opacity: 0 }}
            className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg"
          >
            <h2 className="text-3xl font-bold text-center mb-6 text-gray-800">{initialData?.id ? 'Edit Utang' : 'Tambah Utang Baru'}</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Nama Utang</label>
                <input
                  type="text"
                  value={debtName}
                  onChange={(e) => setDebtName(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Contoh: KTA Bank A"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Jumlah Awal (Rp)</label>
                <input
                  type="number"
                  value={originalAmount}
                  onChange={(e) => setOriginalAmount(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="10000000"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Cicilan Bulanan (Rp)</label>
                <input
                  type="number"
                  value={monthlyPayment}
                  onChange={(e) => setMonthlyPayment(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="500000"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Sisa Bulan</label>
                <input
                  type="number"
                  value={remainingMonths}
                  onChange={(e) => setRemainingMonths(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="24"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-700 font-semibold mb-2">Tanggal Jatuh Tempo (Hari)</label>
                <input
                  type="number"
                  value={dueDate}
                  onChange={(e) => setDueDate(e.target.value)}
                  min="1"
                  max="31"
                  className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="5 (tanggal 5 setiap bulan)"
                  required
                />
              </div>
              <div className="flex justify-end space-x-4 mt-6">
                <button
                  type="button"
                  onClick={onClose}
                  className="py-3 px-6 bg-gray-200 text-gray-800 rounded-full font-semibold transition-all duration-200 hover:bg-gray-300"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  className="py-3 px-6 bg-indigo-600 text-white rounded-full font-semibold transition-all duration-200 hover:bg-indigo-700"
                >
                  Simpan
                </button>
              </div>
            </form>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

// Komponen utama aplikasi
const App = () => {
  const [debts, setDebts] = useState([
    {
      id: crypto.randomUUID(),
      name: 'Kredit Mobil',
      originalAmount: 120000000,
      monthlyPayment: 2500000,
      remainingAmount: 60000000,
      remainingMonths: 24,
      dueDate: 10,
      lastPaymentDate: new Date('2024-07-01'),
    },
    {
      id: crypto.randomUUID(),
      name: 'KTA',
      originalAmount: 20000000,
      monthlyPayment: 1000000,
      remainingAmount: 5000000,
      remainingMonths: 5,
      dueDate: 25,
      lastPaymentDate: new Date('2024-07-20'),
    },
    {
      id: crypto.randomUUID(),
      name: 'Kartu Kredit',
      originalAmount: 5000000,
      monthlyPayment: 500000,
      remainingAmount: 500000,
      remainingMonths: 1,
      dueDate: 15,
      lastPaymentDate: new Date('2024-07-14'),
    },
  ]);
  const [income, setIncome] = useState(15000000);
  const [showAddModal, setShowAddModal] = useState(false);
  const [editData, setEditData] = useState(null);
  const [totalRemainingDebt, setTotalRemainingDebt] = useState(0);
  const [thisMonthPayment, setThisMonthPayment] = useState(0);
  const [salaryStatus, setSalaryStatus] = useState({ status: 'Cukup', remaining: 0 });

  // State baru untuk fitur filter
  const [filterStatus, setFilterStatus] = useState('all');
  const [filterName, setFilterName] = useState('');

  const today = new Date();
  const currentMonth = today.getMonth();
  const currentYear = today.getFullYear();

  useEffect(() => {
    // Menghitung total sisa utang dan cicilan bulan ini
    let totalRemaining = 0;
    let totalMonthlyPayment = 0;
    
    debts.forEach(debt => {
      totalRemaining += debt.remainingAmount;
      // Periksa apakah utang jatuh tempo bulan ini dan belum dibayar
      if (debt.remainingAmount > 0) {
        if (debt.lastPaymentDate) {
          const lastPaymentMonth = debt.lastPaymentDate.getMonth();
          const lastPaymentYear = debt.lastPaymentDate.getFullYear();
          // Jika pembayaran terakhir bukan di bulan & tahun ini
          if (lastPaymentMonth !== currentMonth || lastPaymentYear !== currentYear) {
            totalMonthlyPayment += debt.monthlyPayment;
          }
        } else {
          // Jika belum pernah dibayar sama sekali
          totalMonthlyPayment += debt.monthlyPayment;
        }
      }
    });

    setTotalRemainingDebt(totalRemaining);
    setThisMonthPayment(totalMonthlyPayment);

    // Mengecek kecukupan gaji
    const remainingSalary = income - totalMonthlyPayment;
    if (remainingSalary >= 0) {
      setSalaryStatus({ status: 'Cukup', remaining: remainingSalary });
    } else {
      setSalaryStatus({ status: 'Tidak Cukup', remaining: remainingSalary });
    }
  }, [debts, income, currentMonth, currentYear]);

  // Fungsi untuk menambah atau mengedit utang
  const handleAddOrUpdateDebt = (newDebt) => {
    if (newDebt.id) {
      // Ini adalah edit
      setDebts(debts.map(d => (d.id === newDebt.id ? newDebt : d)));
    } else {
      // Ini adalah tambah baru
      setDebts([...debts, { ...newDebt, id: crypto.randomUUID() }]);
    }
    setEditData(null);
  };

  // Fungsi untuk membayar cicilan
  const payDebt = (id) => {
    setDebts(
      debts.map((debt) => {
        if (debt.id === id && debt.remainingAmount > 0) {
          const updatedRemainingAmount = debt.remainingAmount - debt.monthlyPayment;
          return {
            ...debt,
            remainingAmount: updatedRemainingAmount < 0 ? 0 : updatedRemainingAmount,
            remainingMonths: debt.remainingMonths - 1,
            lastPaymentDate: new Date(),
          };
        }
        return debt;
      })
    );
  };

  // Fungsi untuk menghapus utang
  const deleteDebt = (id) => {
    setDebts(debts.filter(debt => debt.id !== id));
  };

  // Fungsi untuk memformat mata uang Rupiah
  const formatRupiah = (number) => {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(number);
  };
  
  // Fungsi untuk mengecek apakah utang sudah dibayar bulan ini
  const hasPaidThisMonth = (lastPaymentDate) => {
    if (!lastPaymentDate) return false;
    return lastPaymentDate.getMonth() === currentMonth && lastPaymentDate.getFullYear() === currentYear;
  };

  // Filter daftar utang berdasarkan status DAN nama
  const filteredDebts = debts.filter(debt => {
    const statusMatch = filterStatus === 'all' || 
                      (filterStatus === 'paid' && hasPaidThisMonth(debt.lastPaymentDate)) ||
                      (filterStatus === 'unpaid' && !hasPaidThisMonth(debt.lastPaymentDate) && debt.remainingAmount > 0);
    
    const nameMatch = debt.name.toLowerCase().includes(filterName.toLowerCase());

    return statusMatch && nameMatch;
  });

  const getFilterButtonClasses = (status) => (
    `py-2 px-5 rounded-full font-semibold transition-colors duration-200 ${
      filterStatus === status
        ? 'bg-indigo-600 text-white shadow-md'
        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
    }`
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-100 p-4 font-inter text-gray-800">
      <div className="container mx-auto max-w-7xl">
        <header className="text-center py-10 mb-8">
          <h1 className="text-4xl sm:text-5xl font-extrabold text-indigo-800 drop-shadow-md">
            Dashboard Pengelolaan Utang
          </h1>
          <p className="mt-3 text-lg text-gray-600">
            Kelola utang Anda dengan mudah dan pastikan keuangan tetap sehat.
          </p>
        </header>

        {/* Ringkasan Dashboard */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          <StatCard
            icon={CreditCard}
            title="Total Sisa Utang"
            value={formatRupiah(totalRemainingDebt)}
            colorClass="bg-gradient-to-r from-red-500 to-red-600"
          />
          <StatCard
            icon={Calendar}
            title="Cicilan Bulan Ini"
            value={formatRupiah(thisMonthPayment)}
            colorClass="bg-gradient-to-r from-indigo-500 to-indigo-600"
          />
          <div className="flex flex-col items-center p-6 rounded-3xl shadow-xl transform transition-all duration-300 hover:scale-105 bg-white text-gray-800">
            {salaryStatus.status === 'Cukup' ? (
              <CheckCircle size={48} className="text-green-500" />
            ) : (
              <XCircle size={48} className="text-red-500" />
            )}
            <h3 className="mt-4 text-xl font-bold">Kecukupan Gaji</h3>
            <p className="mt-2 text-2xl font-extrabold">{salaryStatus.status}</p>
            <p className="mt-2 text-lg font-semibold">Sisa: {formatRupiah(salaryStatus.remaining)}</p>
          </div>
        </div>

        {/* Pengelolaan Pendapatan */}
        <div className="bg-white p-6 rounded-3xl shadow-xl mb-12">
          <h2 className="text-2xl font-bold mb-4 flex items-center text-gray-800">
            <PiggyBank size={24} className="mr-2 text-green-600" />
            Pendapatan Bulanan
          </h2>
          <div className="flex items-center space-x-4">
            <input
              type="number"
              value={income}
              onChange={(e) => setIncome(parseFloat(e.target.value))}
              className="w-full max-w-xs p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-lg"
              placeholder="Pendapatan Bulanan Anda"
            />
          </div>
        </div>

        {/* Daftar Utang */}
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">Daftar Utang</h2>
          <button
            onClick={() => { setEditData(null); setShowAddModal(true); }}
            className="flex items-center bg-indigo-600 text-white py-3 px-6 rounded-full font-semibold shadow-lg transition-all duration-200 hover:bg-indigo-700 hover:shadow-xl"
          >
            <Plus size={20} className="mr-2" />
            Tambah Utang
          </button>
        </div>

        {/* Kontrol Filter */}
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setFilterStatus('all')}
              className={getFilterButtonClasses('all')}
            >
              Semua
            </button>
            <button
              onClick={() => setFilterStatus('unpaid')}
              className={getFilterButtonClasses('unpaid')}
            >
              Belum Dibayar
            </button>
            <button
              onClick={() => setFilterStatus('paid')}
              className={getFilterButtonClasses('paid')}
            >
              Sudah Dibayar
            </button>
          </div>
          <div className="relative w-full sm:w-auto">
            <Search size={20} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
            <input
              type="text"
              value={filterName}
              onChange={(e) => setFilterName(e.target.value)}
              className="w-full sm:w-64 p-3 pl-10 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="Cari berdasarkan nama utang..."
            />
          </div>
        </div>

        <div className="space-y-4">
          <AnimatePresence>
            {filteredDebts.map((debt) => (
              <motion.div
                key={debt.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, x: -50 }}
                transition={{ duration: 0.3 }}
                className="bg-white p-6 rounded-3xl shadow-md flex flex-col md:flex-row items-start md:items-center justify-between transition-all duration-300 hover:shadow-lg"
              >
                <div className="flex-1 mb-4 md:mb-0">
                  <h3 className="text-xl font-bold text-gray-900">{debt.name}</h3>
                  <p className="text-gray-600">Sisa Utang: <span className="font-semibold">{formatRupiah(debt.remainingAmount)}</span></p>
                  <p className="text-gray-600">Sisa Bulan: <span className="font-semibold">{debt.remainingMonths}</span></p>
                  <p className="text-gray-600">Cicilan/Bulan: <span className="font-semibold">{formatRupiah(debt.monthlyPayment)}</span></p>
                  <p className="text-sm text-gray-500 mt-1">Jatuh Tempo: Tanggal {debt.dueDate} setiap bulan</p>
                </div>
                <div className="flex space-x-2">
                  <button
                    onClick={() => { setEditData(debt); setShowAddModal(true); }}
                    className="p-3 bg-yellow-100 text-yellow-600 rounded-full transition-all duration-200 hover:bg-yellow-200"
                    aria-label="Edit Utang"
                  >
                    <Edit size={20} />
                  </button>
                  <button
                    onClick={() => deleteDebt(debt.id)}
                    className="p-3 bg-red-100 text-red-600 rounded-full transition-all duration-200 hover:bg-red-200"
                    aria-label="Hapus Utang"
                  >
                    <Trash2 size={20} />
                  </button>
                  <button
                    onClick={() => payDebt(debt.id)}
                    disabled={debt.remainingAmount <= 0 || hasPaidThisMonth(debt.lastPaymentDate)}
                    className={`py-3 px-6 rounded-full font-semibold transition-all duration-200 ${
                      debt.remainingAmount <= 0 || hasPaidThisMonth(debt.lastPaymentDate)
                        ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
                        : 'bg-green-500 text-white hover:bg-green-600'
                    }`}
                  >
                    {hasPaidThisMonth(debt.lastPaymentDate) ? 'Sudah Dibayar' : 'Bayar'}
                  </button>
                </div>
              </motion.div>
            ))}
          </AnimatePresence>
          {filteredDebts.length === 0 && (
            <p className="text-center text-gray-500 text-lg py-8">
              Tidak ada utang yang cocok dengan filter.
            </p>
          )}
        </div>
      </div>
      <DebtFormModal
        isOpen={showAddModal}
        onClose={() => { setShowAddModal(false); setEditData(null); }}
        onSubmit={handleAddOrUpdateDebt}
        initialData={editData}
      />
    </div>
  );
};

export default App;
